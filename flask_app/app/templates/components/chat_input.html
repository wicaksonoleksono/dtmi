<!-- Chat Input Component -->
<div
  class="sticky bottom-0 p-4 lg:p-6 backdrop-blur-xl"
  :class="darkMode ? 'bg-claude-bg-dark/80' : 'bg-claude-bg/80'"
>
  <div class="max-w-4xl mx-auto">
    <!-- Input Form -->
    <form @submit.prevent="sendMessage()">
      <!-- Container for input field with filter and send button -->
      <div
        class="relative"
        x-data="{ 
          filterOpen: false,
          activeTab: 'jenjang',
          get tabTransform() {
              return this.activeTab === 'jenjang' ? 'translateX(0%)' : 'translateX(100%)';
          }
      }"
      >
        <!-- Input Field Container -->
        <div
          class="relative rounded-3xl shadow-2xl backdrop-blur-xl overflow-hidden"
          :class="darkMode ? 'bg-claude-surface-dark/90 border border-claude-border-dark' : 'bg-claude-surface/90 border border-claude-border'"
        >
          <!-- Filter Button (di kiri dalam input) -->
          <button
            type="button"
            @click="filterOpen = !filterOpen"
            :disabled="isLoading"
            class="absolute left-3 bottom-3 w-12 h-12 rounded-2xl backdrop-blur-xl border transition-all duration-300 hover:scale-105 active:scale-95 disabled:cursor-not-allowed disabled:opacity-50 shadow-lg flex items-center justify-center z-10"
            :class="filterOpen 
                  ? 'bg-orange-500 border-orange-500 text-white'
                  : (darkMode ? 'bg-claude-surface-dark/90 border-claude-border-dark hover:border-orange-400' : 'bg-claude-surface/90 border-claude-border hover:border-orange-400')"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"
              />
            </svg>
          </button>

          <!-- Textarea dengan padding untuk filter dan send button -->
          <textarea
            x-model="currentMessage"
            @input="adjustTextareaHeight()"
            @keydown="handleKeydown($event)"
            :disabled="isLoading"
            :placeholder="window.innerWidth >= 768 ? 'Tanya apapun tentang DTMI... (Enter untuk kirim, Shift+Enter untuk baris baru)' : 'Tanya tentang DTMI...'"
            x-ref="messageTextarea"
            rows="1"
            class="w-full pl-20 pr-20 py-4 bg-transparent resize-none focus:outline-none placeholder-opacity-60 transition-all duration-200"
            :class="darkMode ? 'text-claude-text-dark placeholder-claude-text-muted-dark' : 'text-claude-text placeholder-claude-text-muted'"
            style="min-height: 60px; max-height: 200px; scrollbar-width: none"
          ></textarea>

          <!-- Send Button (di kanan dalam input) -->
          <button
            type="submit"
            :disabled="!currentMessage.trim() || isLoading"
            class="absolute right-3 bottom-3 w-12 h-12 rounded-2xl flex items-center justify-center transition-all duration-300 hover:scale-105 active:scale-95 disabled:cursor-not-allowed disabled:opacity-50 shadow-lg z-10"
            :class="!currentMessage.trim() || isLoading 
                              ? (darkMode ? 'bg-claude-primary-dark' : 'bg-claude-primary') 
                              : 'bg-claude-orange hover:bg-claude-orange/90'"
          >
            <svg
              x-show="!isLoading"
              class="w-6 h-6 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
            <svg
              x-show="isLoading"
              class="animate-spin w-6 h-6 text-white"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Filter Panel (Opens Upward from Filter Button Position) -->
        <div
          x-show="filterOpen"
          x-cloak
          x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 transform translate-y-4 scale-95"
          x-transition:enter-end="opacity-100 transform translate-y-0 scale-100"
          x-transition:leave="transition ease-in duration-200"
          x-transition:leave-start="opacity-100 transform translate-y-0 scale-100"
          x-transition:leave-end="opacity-0 transform translate-y-4 scale-95"
          class="absolute bottom-full left-3 mb-3 w-72 max-w-[calc(100vw-2rem)] z-[9999]"
        >
          <div
            class="rounded-2xl backdrop-blur-xl border shadow-2xl overflow-hidden"
            :class="darkMode ? 'bg-claude-surface-dark/95 border-claude-border-dark' : 'bg-claude-surface/95 border-claude-border'"
          >
            <!-- Tab Headers -->
            <div class="relative px-3 pt-3">
              <div
                class="relative flex rounded-xl p-1 overflow-hidden"
                :class="darkMode ? 'bg-claude-border-dark' : 'bg-claude-border'"
              >
                <!-- Sliding Background (now correctly clipped inside the track) -->
                <div
                  class="absolute top-1 bottom-1 left-1 w-[calc(50%-8px)] rounded-md transition-transform duration-300 ease-out pointer-events-none"
                  :class="darkMode ? 'bg-claude-surface-dark shadow-md' : 'bg-claude-surface shadow-md'"
                  :style="{ transform: tabTransform }"
                ></div>

                <!-- Tab Buttons -->
                <button
                  type="button"
                  @click="activeTab = 'jenjang'"
                  class="relative z-10 flex-1 pt-1 pb-1 px-2 text-xs font-medium rounded-lg transition-colors duration-300"
                  :class="activeTab === 'jenjang' 
                    ? (darkMode ? 'text-claude-text-dark' : 'text-claude-text')
                    : 'text-gray-500'"
                >
                  Jenjang
                </button>
                <button
                  type="button"
                  @click="activeTab = 'tipe'"
                  class="relative z-10 flex-1 pt-1 pb-1 px-2 text-xs font-medium rounded-lg transition-colors duration-300"
                  :class="activeTab === 'tipe' 
                    ? (darkMode ? 'text-claude-text-dark' : 'text-claude-text')
                    : 'text-gray-500'"
                >
                  Tipe
                </button>
              </div>
            </div>

            <!-- Tab Content Container with proper height and spacing -->
            <div class="relative pt-4 pb-4 px-4 min-h-[220px] overflow-hidden">
              <!-- Jenjang Tab -->
              <div
                x-show="activeTab === 'jenjang'"
                x-transition:enter="transition ease-out duration-250"
                x-transition:enter-start="opacity-0 transform translate-x-[-100%]"
                x-transition:enter-end="opacity-100 transform translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform translate-x-0"
                x-transition:leave-end="opacity-0 transform translate-x-[-100%]"
                class="absolute inset-0 w-full pt-4 pb-4 px-4"
              >
                <div class="space-y-3">
                  <template x-for="option in yearFilters" :key="option.value">
                    <button
                      type="button"
                      @click="selectYear(option.value); filterOpen = false"
                      :disabled="isLoading"
                      class="w-full flex items-center justify-between pt-2 pb-2 px-3 rounded-lg transition-all duration-200 hover:scale-[1.02] disabled:cursor-not-allowed disabled:opacity-50"
                      :class="selectedYear === option.value
                                        ? 'bg-orange-500 text-white shadow-md'
                                        : (darkMode 
                                            ? 'bg-claude-border-dark hover:bg-gray-600 text-claude-text-dark' 
                                            : 'bg-claude-border hover:bg-gray-200 text-claude-text')"
                    >
                      <span
                        class="font-medium text-xs"
                        x-text="option.label"
                      ></span>
                      <div
                        x-show="selectedYear === option.value"
                        class="w-4 h-4 rounded-full bg-white bg-opacity-30 flex items-center justify-center"
                      >
                        <svg
                          class="w-2 h-2"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                            clip-rule="evenodd"
                          />
                        </svg>
                      </div>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Tipe Konten Tab -->
              <div
                x-show="activeTab === 'tipe'"
                x-transition:enter="transition ease-out duration-250"
                x-transition:enter-start="opacity-0 transform translate-x-[100%]"
                x-transition:enter-end="opacity-100 transform translate-x-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform translate-x-0"
                x-transition:leave-end="opacity-0 transform translate-x-[100%]"
                class="absolute inset-0 w-full pt-4 pb-4 px-4"
              >
                <div class="grid grid-cols-2 gap-3">
                  <template x-for="option in filters" :key="option.value">
                    <button
                      type="button"
                      @click="selectFilter(option.value); filterOpen = false"
                      :disabled="isLoading"
                      class="relative flex flex-col items-center pt-2 pb-2 px-2 rounded-lg transition-all duration-200 hover:scale-[1.02] disabled:cursor-not-allowed disabled:opacity-50 min-h-[50px]"
                      :class="selectedFilter === option.value
                                        ? 'bg-orange-500 text-white shadow-md'
                                        : (darkMode 
                                            ? 'bg-claude-border-dark hover:bg-gray-600 text-claude-text-dark' 
                                            : 'bg-claude-border hover:bg-gray-200 text-claude-text')"
                    >
                      <div class="mb-1" x-html="option.icon"></div>
                      <span
                        class="text-xs font-medium text-center leading-tight"
                        x-text="option.label"
                      ></span>
                      <div
                        x-show="selectedFilter === option.value"
                        class="absolute top-1 right-1 w-3 h-3 rounded-full bg-white bg-opacity-30 flex items-center justify-center"
                      >
                        <svg
                          class="w-1.5 h-1.5"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                            clip-rule="evenodd"
                          />
                        </svg>
                      </div>
                    </button>
                  </template>
                </div>
              </div>
            </div>

            <!-- Current Selection Indicator -->
            <div class="px-3 pb-3">
              <div
                class="text-xs text-center p-1.5 rounded-lg"
                :class="darkMode ? 'bg-claude-border-dark text-gray-400' : 'bg-claude-border text-gray-600'"
              >
                <span class="inline-flex items-center gap-1">
                  <span
                    x-text="yearFilters.find(y => y.value === selectedYear)?.label || 'Semua'"
                  ></span>
                  <span class="mx-1">•</span>
                  <span
                    x-text="filters.find(f => f.value === selectedFilter)?.label || 'Semua'"
                  ></span>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Backdrop -->
        <div
          x-show="filterOpen"
          x-cloak
          @click="filterOpen = false"
          class="fixed inset-0 z-40"
          x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0"
          x-transition:enter-end="opacity-100"
          x-transition:leave="transition ease-in duration-150"
          x-transition:leave-start="opacity-100"
          x-transition:leave-end="opacity-0"
        ></div>
      </div>
    </form>

    {% include 'components/status_info.html' %}
  </div>
</div>
